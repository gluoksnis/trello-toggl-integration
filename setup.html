<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <style>
    body {
      padding: 10px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }
    input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
      border: 1px solid #dfe1e6;
      border-radius: 3px;
    }
    button {
      width: 100%;
      padding: 10px;
      background-color: #0079BF;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 10px;
      border-radius: 3px;
    }
    button:hover {
      background-color: #026aa7;
    }
    .help-text {
      font-size: 11px;
      color: #5e6c84;
      margin-top: 3px;
      line-height: 1.3;
    }
  </style>
</head>
<body>
  <form id="setupForm">
    <label for="apiToken">Toggl API Token:</label>
    <input type="password" id="apiToken" placeholder="Your Toggl API token" required>
    <div class="help-text">Find in Toggl Track → Profile → API Token</div>
    
    <label for="workspaceId">Workspace ID:</label>
    <input type="number" id="workspaceId" placeholder="e.g., 1234567" required>
    <div class="help-text">Find in Toggl Track → Settings</div>
    
    <button type="submit" class="mod-primary">Save Configuration</button>
  </form>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script>
    /* global TrelloPowerUp */
    
    var t = TrelloPowerUp.iframe();
    
    // Load existing settings if any
    Promise.all([
      t.get('card', 'shared', 'togglApiToken'),
      t.get('card', 'shared', 'togglWorkspaceId')
    ]).then(function(values) {
      var token = values[0];
      var workspaceId = values[1];
      
      if (token) {
        document.getElementById('apiToken').value = token;
      }
      if (workspaceId) {
        document.getElementById('workspaceId').value = workspaceId;
      }
      
      // Size the popup after content loads
      t.sizeTo('#setupForm');
    });
    
    document.getElementById('setupForm').addEventListener('submit', function(event) {
      event.preventDefault();
      
      var apiToken = document.getElementById('apiToken').value.trim();
      var workspaceId = document.getElementById('workspaceId').value.trim();
      
      if (!apiToken || !workspaceId) {
        alert('Please fill in both fields');
        return;
      }
      
      // Verify the API token works
      fetch('https://api.track.toggl.com/api/v9/me', {
        headers: {
          'Authorization': 'Basic ' + btoa(apiToken + ':api_token')
        }
      })
      .then(function(response) {
        if (!response.ok) {
          throw new Error('Invalid API token');
        }
        return response.json();
      })
      .then(function(userData) {
        // Save the settings
        return t.set('card', 'shared', {
          togglApiToken: apiToken,
          togglWorkspaceId: workspaceId
        });
      })
      .then(function() {
        return t.alert({
          message: 'Toggl configured successfully!',
          duration: 3
        });
      })
      .then(function() {
        return t.closePopup();
      })
      .catch(function(error) {
        alert('Error: ' + error.message + '. Please check your API token and workspace ID.');
      });
    });
  </script>
</body>
</html>