<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <style>
    body {
      padding: 10px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }
    input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
      border: 1px solid #dfe1e6;
      border-radius: 3px;
    }
    button {
      width: 100%;
      padding: 10px;
      background-color: #0079BF;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 10px;
      border-radius: 3px;
    }
    button:hover {
      background-color: #026aa7;
    }
    .help-text {
      font-size: 11px;
      color: #5e6c84;
      margin-top: 3px;
      line-height: 1.3;
    }
  </style>
</head>
<body>
  <form id="setupForm">
    <label for="apiToken">Toggl API Token:</label>
    <input type="password" id="apiToken" placeholder="Your Toggl API token" required>
    <div class="help-text">Find in Toggl Track → Profile → API Token</div>
    
    <label for="workspaceId">Workspace ID:</label>
    <input type="number" id="workspaceId" placeholder="e.g., 1234567" required>
    <div class="help-text">Find in Toggl Track → Settings</div>
    
    <label for="corsProxyUrl">CORS Proxy URL (optional):</label>
    <input type="text" id="corsProxyUrl" placeholder="https://your-worker.workers.dev/?url=">
    <div class="help-text">Your Cloudflare Worker URL. Leave empty to use default.</div>
    
    <button type="submit" class="mod-primary">Save Configuration</button>
  </form>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script>
    /* global TrelloPowerUp */
    
    var t = TrelloPowerUp.iframe();
    
    // Load existing settings if any from BOARD level
    Promise.all([
      t.get('board', 'shared', 'togglApiToken'),
      t.get('board', 'shared', 'togglWorkspaceId'),
      t.get('board', 'shared', 'corsProxyUrl')
    ]).then(function(values) {
      var token = values[0];
      var workspaceId = values[1];
      var corsProxyUrl = values[2];
      
      if (token) {
        document.getElementById('apiToken').value = token;
      }
      if (workspaceId) {
        document.getElementById('workspaceId').value = workspaceId;
      }
      if (corsProxyUrl) {
        document.getElementById('corsProxyUrl').value = corsProxyUrl;
      }
      
      // Size the popup after content loads
      t.sizeTo('#setupForm');
    });
    
    document.getElementById('setupForm').addEventListener('submit', function(event) {
      event.preventDefault();
      
      var apiToken = document.getElementById('apiToken').value.trim();
      var workspaceId = document.getElementById('workspaceId').value.trim();
      var corsProxyUrl = document.getElementById('corsProxyUrl').value.trim();
      
      if (!apiToken || !workspaceId) {
        alert('Please fill in both required fields');
        return;
      }
      
      // Basic validation
      if (apiToken.length < 20) {
        alert('API token seems too short. Please check you copied the full token.');
        return;
      }
      
      if (isNaN(workspaceId) || workspaceId.length < 5) {
        alert('Workspace ID should be a number (e.g., 1234567)');
        return;
      }
      
      // Prepare settings object
      var settings = {
        togglApiToken: apiToken,
        togglWorkspaceId: workspaceId
      };
      
      // Add CORS proxy URL if provided
      if (corsProxyUrl) {
        settings.corsProxyUrl = corsProxyUrl;
      }
      
      // Save to BOARD scope (applies to all cards on this board)
      t.set('board', 'shared', settings)
      .then(function() {
        return t.alert({
          message: 'Settings saved for entire board! Try starting a timer.',
          duration: 4
        });
      })
      .then(function() {
        return t.closePopup();
      })
      .catch(function(error) {
        alert('Error saving settings: ' + error.message);
      });
    });
  </script>
</body>
</html>